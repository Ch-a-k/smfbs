# Система бронирования

Система бронирования с возможностью управления комнатами, пакетами услуг и расписанием работы.

## Содержание

- [Требования](#требования)
- [Установка](#установка)
- [Настройка базы данных](#настройка-базы-данных)
- [Запуск приложения](#запуск-приложения)
- [Структура проекта](#структура-проекта)
- [API](#api)
- [Устранение проблем](#устранение-проблем)

## Требования

- Node.js (версия 18.x или выше)
- npm или yarn
- Supabase аккаунт и проект

## Установка

1. Клонировать репозиторий:
   ```
   git clone <url-репозитория>
   cd <директория-проекта>
   ```

2. Установить зависимости:
   ```
   npm install
   ```
   или
   ```
   yarn install
   ```

3. Настройка переменных окружения:
   - Создайте файл `.env.local` в корневой директории проекта
   - Добавьте следующие переменные:
     ```
     NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-url.supabase.co
     NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
     NEXT_PUBLIC_APP_URL=http://localhost:3000
     ```

## Настройка базы данных

1. Создайте проект в [Supabase](https://supabase.com/)

2. Получите URL и ANON KEY проекта из настроек проекта в Supabase:
   - Project Settings -> API -> Project URL
   - Project Settings -> API -> Project API keys -> anon public

3. Создайте таблицы в базе данных, выполнив скрипт:
   ```
   npm run db:create-tables
   ```
   или
   ```
   yarn db:create-tables
   ```

4. Если требуется синхронизировать или обновить структуру существующей базы данных:
   ```
   npm run db:sync
   ```
   или
   ```
   yarn db:sync
   ```

## Запуск приложения

1. Запуск в режиме разработки:
   ```
   npm run dev
   ```
   или
   ```
   yarn dev
   ```

2. Сборка для продакшн:
   ```
   npm run build
   ```
   или
   ```
   yarn build
   ```

3. Запуск сборки:
   ```
   npm run start
   ```
   или
   ```
   yarn start
   ```

Приложение будет доступно по адресу [http://localhost:3000](http://localhost:3000)

## Структура проекта

```
├── public/                 # Статические файлы
├── scripts/                # Скрипты для настройки и управления базой данных
│   ├── create-tables.sql   # SQL для создания таблиц
│   ├── create-tables.js    # Скрипт для создания таблиц
│   └── sync-database.js    # Скрипт для синхронизации структуры БД
├── src/
│   ├── app/                # Компоненты Next.js App Router
│   │   ├── admin/          # Административная панель
│   │   ├── api/            # API маршруты
│   │   └── booking/        # Страницы бронирования
│   ├── components/         # Компоненты приложения
│   │   ├── admin/          # Компоненты для админ-панели
│   │   ├── booking/        # Компоненты для бронирования
│   │   └── ui/             # UI компоненты
│   ├── lib/                # Библиотеки
│   ├── types/              # TypeScript типы
│   └── utils/              # Утилиты
├── .env.local              # Переменные окружения (не включено в репозиторий)
├── package.json            # Зависимости и скрипты
└── README.md               # Документация
```

## API

### Комнаты

- `GET /api/rooms` - Получить список всех комнат
- `GET /api/rooms?id=<id>` - Получить комнату по id
- `POST /api/rooms` - Создать новую комнату
- `PUT /api/rooms` - Обновить существующую комнату
- `DELETE /api/rooms?id=<id>` - Удалить комнату

### Пакеты услуг

- `GET /api/packages` - Получить список всех пакетов
- `GET /api/packages?id=<id>` - Получить пакет по id
- `POST /api/packages` - Создать новый пакет
- `PUT /api/packages` - Обновить существующий пакет
- `DELETE /api/packages?id=<id>` - Удалить пакет

### Бронирования

- `GET /api/bookings` - Получить список всех бронирований
- `GET /api/bookings?id=<id>` - Получить бронирование по id
- `POST /api/bookings` - Создать новое бронирование
- `PUT /api/bookings` - Обновить существующее бронирование
- `DELETE /api/bookings?id=<id>` - Удалить бронирование

### Проверка доступности

- `GET /api/bookings/availability?date=<YYYY-MM-DD>&packageId=<id>&type=slots` - Получить доступные временные слоты
- `GET /api/bookings/availability?date=<YYYY-MM-DD>&startTime=<HH:MM>&packageId=<id>&type=rooms` - Получить доступные комнаты

## Устранение проблем

### Проблема: Не удается подключиться к базе данных

1. Проверьте правильность URL и ключа Supabase в файле `.env.local`
2. Убедитесь, что ваш IP-адрес не заблокирован в настройках Supabase

### Проблема: Ошибки при создании таблиц

1. Проверьте наличие необходимых прав доступа в Supabase
2. Попробуйте выполнить SQL-запросы напрямую в SQL Editor в Supabase

### Проблема: Ошибка "Failed to fetch bookings"

1. Убедитесь, что таблицы в базе данных созданы корректно
2. Проверьте наличие таблицы `bookings` в вашей базе данных
3. Выполните скрипт синхронизации: `npm run db:sync`

### Проблема: Расписание комнат не отображается корректно

1. Проверьте структуру поля `work_schedule` в таблице `rooms`
2. Убедитесь, что формат данных соответствует ожидаемому (см. файл `src/types/booking.ts`)
3. Выполните скрипт синхронизации: `npm run db:sync`

### Проблема: Интерфейс отображается некорректно

1. Убедитесь, что вы используете совместимый браузер
2. Проверьте, что все необходимые зависимости установлены
3. Попробуйте очистить кэш браузера или использовать режим инкогнито

### Исправление проблем с базой данных

Если у вас возникают ошибки, связанные с отсутствием колонок в таблице bookings, выполните следующие шаги:

#### Автоматическое исправление (рекомендуется)

1. Запустите скрипт проверки и исправления таблицы bookings:
   ```
   npm run db:fix-bookings
   ```

2. Если автоматическое исправление не помогло, запустите SQL-скрипт:
   ```
   npm run db:fix-bookings-sql
   ```

#### Ручное исправление

Если автоматические методы не работают, вы можете исправить проблему вручную:

1. Войдите в Supabase Dashboard: https://app.supabase.com
2. Выберите ваш проект
3. Перейдите в раздел "SQL Editor"
4. Создайте новый запрос и вставьте содержимое файла `scripts/fix-bookings-columns.sql`
5. Выполните запрос

Этот запрос добавит отсутствующие колонки в таблицу bookings и исправит типы данных.

#### Ошибка "column bookings.booking_date does not exist"

Если вы видите эту ошибку, выполните следующий SQL запрос в SQL Editor:

```sql
ALTER TABLE bookings ADD COLUMN IF NOT EXISTS booking_date DATE;
UPDATE bookings SET booking_date = created_at::date WHERE booking_date IS NULL;
```

### Развиваемые функциональности

Некоторые функциональности в приложении находятся в процессе разработки и могут быть недоступны:

1. **Страница бронирования для пользователей** - основная страница бронирования находится в разработке. В ближайшем будущем будет реализована полноценная форма бронирования с выбором пакета, даты, времени и заполнением контактной информации.

#### Временное решение

Для создания бронирований вы можете использовать административную панель или напрямую работать с базой данных:

1. **Через административную панель:**
   - Перейдите в раздел "Bookings" в административной панели
   - Нажмите кнопку "Новое бронирование" и заполните форму

2. **Через Supabase Dashboard** (альтернативный способ):
   - Перейдите в раздел "Table Editor" в Supabase Dashboard
   - Выберите таблицу "bookings"
   - Нажмите "Insert Row" и заполните необходимые поля
   - Убедитесь, что заполнены обязательные поля: room_id, package_id, customer_name, customer_email, customer_phone, booking_date, start_time, end_time, num_people, total_price
# smfbs
# smfbs
# smfbs
