# Система бронирования

Система бронирования с возможностью управления комнатами, пакетами услуг и расписанием работы.

## Содержание
- [MVP](#mvp)
- [Полная версия](#полная-версия)

- [Требования](#требования)
- [Установка](#установка)
- [Настройка базы данных](#настройка-базы-данных)
- [Запуск приложения](#запуск-приложения)
- [Структура проекта](#структура-проекта)
- [API](#api)
- [Устранение проблем](#устранение-проблем)

## ЧТО НУЖНО СДЕЛАТЬ
## MVP (Минимально жизнеспособный продукт)

### MVP

### 2. Основные функциональные требования MVP

#### 2.1. Административная панель

1. **Авторизация**
   - Доступ к административной панели только для авторизованных пользователей
   - Простая форма входа с логином и паролем

2. **Управление бронированиями**
   - Просмотр списка всех бронирований с возможностью фильтрации по:
     - Дате
     - Статусу оплаты (Неоплачено, Депозит оплачен, Полностью оплачено)
     - Текстовому поиску (по имени, email, телефону)
   - Возможность просмотра деталей бронирования
   - Создание нового бронирования с указанием:
     - Клиентских данных (имя, email, телефон)
     - Даты и времени
     - Выбора пакета услуг
     - Выбора комнаты
     - Статуса оплаты
   - Отмена бронирования

3. **Управление комнатами**
   - Просмотр списка всех комнат
   - Создание новой комнаты с указанием:
     - Названия
     - Вместимости (максимальное число людей)
     - Статуса доступности
   - Редактирование существующих комнат

4. **Управление пакетами услуг**
   - Просмотр списка всех пакетов
   - Создание нового пакета с указанием:
     - Названия
     - Описания
     - Стоимости
     - Продолжительности (в минутах)
     - Максимального количества людей
     - Размера депозита
   - Редактирование существующих пакетов

#### 2.2. API для работы с данными

1. **API комнат**
   - Получение списка всех комнат
   - Получение детальной информации о комнате
   - Создание новой комнаты
   - Обновление информации о комнате
   - Удаление комнаты

2. **API пакетов услуг**
   - Получение списка всех пакетов
   - Получение детальной информации о пакете
   - Создание нового пакета
   - Обновление информации о пакете
   - Удаление пакета

3. **API бронирований**
   - Получение списка всех бронирований
   - Получение детальной информации о бронировании
   - Создание нового бронирования
   - Обновление информации о бронировании
   - Отмена бронирования
   - Проверка доступности комнат на конкретные даты и время

#### 2.3. База данных

1. **Таблица комнат (rooms)**
   - id (первичный ключ)
   - name (название)
   - capacity (вместимость)
   - max_people (максимальное количество людей)
   - is_active (статус активности)
   - available (доступность)
   - work_schedule (расписание работы в JSON формате)

2. **Таблица пакетов услуг (packages)**
   - id (первичный ключ)
   - name (название)
   - description (описание)
   - price (стоимость)
   - deposit_amount (размер депозита)
   - duration (продолжительность в минутах)
   - max_people (максимальное количество людей)
   - preferred_rooms (предпочтительные комнаты в JSON формате)
   - is_active (статус активности)

3. **Таблица бронирований (bookings)**
   - id (первичный ключ)
   - room_id (ссылка на комнату)
   - package_id (ссылка на пакет услуг)
   - customer_name (имя клиента)
   - customer_email (email клиента)
   - customer_phone (телефон клиента)
   - booking_date (дата бронирования)
   - start_time (время начала)
   - end_time (время окончания)
   - num_people (количество людей)
   - status (статус бронирования: confirmed, cancelled)
   - total_price (общая стоимость)
   - payment_status (статус оплаты: UNPAID, DEPOSIT_PAID, FULLY_PAID)
   - paid_amount (оплаченная сумма)
   - notes (примечания)
   - created_at (дата создания записи)
   - updated_at (дата обновления записи)

### 3. Технические требования MVP

1. **Фронтенд**
   - Next.js фреймворк с использованием React
   - Адаптивный дизайн (мобильные устройства, планшеты, десктоп)
   - Базовый пользовательский интерфейс с минимальной стилизацией

2. **Бэкенд**
   - Next.js API routes для обработки запросов
   - Интеграция с Supabase для хранения данных

3. **База данных**
   - Supabase (PostgreSQL) для хранения всех данных
   - Использование функций Supabase для проверки доступности комнат

4. **Безопасность**
   - Базовая аутентификация для административной панели
   - Валидация входных данных на стороне клиента и сервера

5. **Развертывание**
   - Локальное развертывание для разработки и тестирования
   - Простая инструкция по установке и настройке

### 4. Интерфейс MVP

1. **Административная панель**
   - Страница авторизации
   - Страница списка бронирований с фильтрами и поиском
   - Модальное окно для создания/редактирования бронирования
   - Страница управления комнатами
   - Страница управления пакетами услуг

2. **Информационная страница для клиентов**
   - Простая страница с информацией о сервисе
   - Сообщение о том, что бронирование через сайт находится в разработке

---

## Полная версия

### 1. Расширенная функциональность

#### 1.1. Клиентский портал

1. **Страница бронирования для клиентов**
   - Пошаговый процесс бронирования:
     - Выбор пакета услуг
     - Выбор даты и времени
     - Выбор доступной комнаты
     - Ввод контактной информации
     - Возможность применения промокода
     - Выбор дополнительных услуг (кросс-селл)
   - Проверка доступности в реальном времени
   - Предварительный расчет стоимости

2. **Личный кабинет клиента**
   - Регистрация и авторизация
   - История бронирований
   - Возможность отмены или изменения бронирования
   - Сохранение контактной информации для будущих бронирований

3. **Система уведомлений**
   - Email-уведомления о бронировании
   - Email-подтверждение после оплаты
   - Напоминания о предстоящем бронировании
   - Административные уведомления о новых бронированиях

#### 1.2. Расширенная административная панель

1. **Детальная аналитика**
   - Дашборд с ключевыми показателями:
     - Количество бронирований по периодам
     - Доход от бронирований
     - Загруженность комнат
     - Популярность пакетов услуг
   - Экспорт отчетов в CSV/Excel

2. **Расширенное управление расписанием**
   - Календарный вид расписания комнат
   - Установка особых рабочих часов для конкретных дат
   - Блокировка определенных дат для обслуживания

3. **Система промокодов**
   - Создание и управление промокодами
   - Установка срока действия и лимита использований
   - Типы скидок (процент, фиксированная сумма)

4. Управление сотрудниками
   - Создание учетных записей для сотрудников
   - Настройка прав доступа
   - Журналирование действий сотрудников

### 2. Интеграция с платежными системами

1. Прием онлайн-платежей
   - Интеграция с платежными шлюзами (Przelewy24 или другие)
   - Оплата полной стоимости или только депозита
   - Формирование электронных чеков

2. Система возвратов
   - Автоматический или ручной возврат средств
   - Частичный возврат при отмене бронирования
   - Учет комиссий платежных систем

### 3. Расширенные технические возможности

1. Производительность и масштабируемость
   - Кэширование частых запросов
   - Оптимизация запросов к базе данных
   - Возможность горизонтального масштабирования

2. Улучшенная безопасность
   - Двухфакторная аутентификация
   - Шифрование чувствительных данных
   - Защита от распространенных атак (CSRF, XSS)
   - Регулярное резервное копирование данных


### 4. SEO-оптимизация и маркетинг

1. SEO-оптимизация
   - Оптимизация метаданных
   - Семантическая структура HTML
   - Карта сайта и robots.txt

2. Интеграция с маркетинговыми инструментами
   - Google Analytics
   - Пиксели рекламных систем
   - Инструменты для email-маркетинга


## Требования

- Node.js (версия 18.x или выше)
- npm или yarn
- Supabase аккаунт и проект

## Установка

1. Клонировать репозиторий:
   ```
   git clone <url-репозитория>
   cd <директория-проекта>
   ```

2. Установить зависимости:
   ```
   npm install
   ```
   или
   ```
   yarn install
   ```

3. Настройка переменных окружения:
   - Создайте файл `.env.local` в корневой директории проекта
   - Добавьте следующие переменные:
     ```
     NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-url.supabase.co
     NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
     NEXT_PUBLIC_APP_URL=http://localhost:3000
     ```

## Настройка базы данных

1. Создайте проект в [Supabase](https://supabase.com/)

2. Получите URL и ANON KEY проекта из настроек проекта в Supabase:
   - Project Settings -> API -> Project URL
   - Project Settings -> API -> Project API keys -> anon public

3. Создайте таблицы в базе данных, выполнив скрипт:
   ```
   npm run db:create-tables
   ```
   или
   ```
   yarn db:create-tables
   ```

4. Если требуется синхронизировать или обновить структуру существующей базы данных:
   ```
   npm run db:sync
   ```
   или
   ```
   yarn db:sync
   ```

## Запуск приложения

1. Запуск в режиме разработки:
   ```
   npm run dev
   ```
   или
   ```
   yarn dev
   ```

2. Сборка для продакшн:
   ```
   npm run build
   ```
   или
   ```
   yarn build
   ```

3. Запуск сборки:
   ```
   npm run start
   ```
   или
   ```
   yarn start
   ```

Приложение будет доступно по адресу [http://localhost:3000](http://localhost:3000)

## Структура проекта

```
├── public/                 # Статические файлы
├── scripts/                # Скрипты для настройки и управления базой данных
│   ├── create-tables.sql   # SQL для создания таблиц
│   ├── create-tables.js    # Скрипт для создания таблиц
│   └── sync-database.js    # Скрипт для синхронизации структуры БД
├── src/
│   ├── app/                # Компоненты Next.js App Router
│   │   ├── admin/          # Административная панель
│   │   ├── api/            # API маршруты
│   │   └── booking/        # Страницы бронирования
│   ├── components/         # Компоненты приложения
│   │   ├── admin/          # Компоненты для админ-панели
│   │   ├── booking/        # Компоненты для бронирования
│   │   └── ui/             # UI компоненты
│   ├── lib/                # Библиотеки
│   ├── types/              # TypeScript типы
│   └── utils/              # Утилиты
├── .env.local              # Переменные окружения (не включено в репозиторий)
├── package.json            # Зависимости и скрипты
└── README.md               # Документация
```

## API

### Комнаты

- `GET /api/rooms` - Получить список всех комнат
- `GET /api/rooms?id=<id>` - Получить комнату по id
- `POST /api/rooms` - Создать новую комнату
- `PUT /api/rooms` - Обновить существующую комнату
- `DELETE /api/rooms?id=<id>` - Удалить комнату

### Пакеты услуг

- `GET /api/packages` - Получить список всех пакетов
- `GET /api/packages?id=<id>` - Получить пакет по id
- `POST /api/packages` - Создать новый пакет
- `PUT /api/packages` - Обновить существующий пакет
- `DELETE /api/packages?id=<id>` - Удалить пакет

### Бронирования

- `GET /api/bookings` - Получить список всех бронирований
- `GET /api/bookings?id=<id>` - Получить бронирование по id
- `POST /api/bookings` - Создать новое бронирование
- `PUT /api/bookings` - Обновить существующее бронирование
- `DELETE /api/bookings?id=<id>` - Удалить бронирование

### Проверка доступности

- `GET /api/bookings/availability?date=<YYYY-MM-DD>&packageId=<id>&type=slots` - Получить доступные временные слоты
- `GET /api/bookings/availability?date=<YYYY-MM-DD>&startTime=<HH:MM>&packageId=<id>&type=rooms` - Получить доступные комнаты

## Устранение проблем

### Проблема: Не удается подключиться к базе данных

1. Проверьте правильность URL и ключа Supabase в файле `.env.local`
2. Убедитесь, что ваш IP-адрес не заблокирован в настройках Supabase

### Проблема: Ошибки при создании таблиц

1. Проверьте наличие необходимых прав доступа в Supabase
2. Попробуйте выполнить SQL-запросы напрямую в SQL Editor в Supabase

### Проблема: Ошибка "Failed to fetch bookings"

1. Убедитесь, что таблицы в базе данных созданы корректно
2. Проверьте наличие таблицы `bookings` в вашей базе данных
3. Выполните скрипт синхронизации: `npm run db:sync`

### Проблема: Расписание комнат не отображается корректно

1. Проверьте структуру поля `work_schedule` в таблице `rooms`
2. Убедитесь, что формат данных соответствует ожидаемому (см. файл `src/types/booking.ts`)
3. Выполните скрипт синхронизации: `npm run db:sync`

### Проблема: Интерфейс отображается некорректно

1. Убедитесь, что вы используете совместимый браузер
2. Проверьте, что все необходимые зависимости установлены
3. Попробуйте очистить кэш браузера или использовать режим инкогнито

### Исправление проблем с базой данных

Если у вас возникают ошибки, связанные с отсутствием колонок в таблице bookings, выполните следующие шаги:

#### Автоматическое исправление (рекомендуется)

1. Запустите скрипт проверки и исправления таблицы bookings:
   ```
   npm run db:fix-bookings
   ```

2. Если автоматическое исправление не помогло, запустите SQL-скрипт:
   ```
   npm run db:fix-bookings-sql
   ```

#### Ручное исправление

Если автоматические методы не работают, вы можете исправить проблему вручную:

1. Войдите в Supabase Dashboard: https://app.supabase.com
2. Выберите ваш проект
3. Перейдите в раздел "SQL Editor"
4. Создайте новый запрос и вставьте содержимое файла `scripts/fix-bookings-columns.sql`
5. Выполните запрос

Этот запрос добавит отсутствующие колонки в таблицу bookings и исправит типы данных.

#### Ошибка "column bookings.booking_date does not exist"

Если вы видите эту ошибку, выполните следующий SQL запрос в SQL Editor:

```sql
ALTER TABLE bookings ADD COLUMN IF NOT EXISTS booking_date DATE;
UPDATE bookings SET booking_date = created_at::date WHERE booking_date IS NULL;
```

### Развиваемые функциональности

Некоторые функциональности в приложении находятся в процессе разработки и могут быть недоступны:

1. **Страница бронирования для пользователей** - основная страница бронирования находится в разработке. В ближайшем будущем будет реализована полноценная форма бронирования с выбором пакета, даты, времени и заполнением контактной информации.

#### Временное решение

Для создания бронирований вы можете использовать административную панель или напрямую работать с базой данных:

1. **Через административную панель:**
   - Перейдите в раздел "Bookings" в административной панели
   - Нажмите кнопку "Новое бронирование" и заполните форму

2. **Через Supabase Dashboard** (альтернативный способ):
   - Перейдите в раздел "Table Editor" в Supabase Dashboard
   - Выберите таблицу "bookings"
   - Нажмите "Insert Row" и заполните необходимые поля
   - Убедитесь, что заполнены обязательные поля: room_id, package_id, customer_name, customer_email, customer_phone, booking_date, start_time, end_time, num_people, total_price